<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <style>
      html {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
          sans-serif;
        font-size: 20px;
      }
      body {
        margin: 0;
        padding: 0;
      }
      #parent {
        background-color: #dde;
        width: 100px;
        height: 100px;
      }
      #child {
        background-color: #aab;
        width: 50px;
        height: 50px;
        position: relative;
        top: 10px;
        left: 10px;
      }
      #parent[data-layout="true"] {
        width: 200px;
        height: 200px;
        position: relative;
        top: 100px;
        left: 100px;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import { patch } from "../index.js";
      import { after } from "../utils.js";
      import S from "https://cdn.skypack.dev/s-js";
      import { animate, mix } from "https://cdn.skypack.dev/popmotion";
      import {
        layoutNode,
        updateProjectionStyle,
      } from "https://cdn.skypack.dev/projection@2.0.0-alpha.3";
      import sync, { cancelSync } from "https://cdn.skypack.dev/framesync";

      function mixRect(prev, next, p) {
        return {
          top: mix(prev.top, next.top, p),
          left: mix(prev.left, next.left, p),
          right: mix(prev.right, next.right, p),
          bottom: mix(prev.bottom, next.bottom, p),
        };
      }

      function pixelsToPercent(pixels, axis) {
        return (pixels / (axis.max - axis.min)) * 100;
      }

      function correctBorderRadius(latest, node) {
        if (typeof latest === "string") {
          if (latest.endsWith("px")) {
            latest = parseFloat(latest);
          } else {
            return latest;
          }
        }
        const { x, y } = node.getTarget();
        return `${pixelsToPercent(latest, x)}% ${pixelsToPercent(latest, y)}%`;
      }

      function animateRect(stream, options = {}) {
        const result = S.data(S.sample(stream));
        S((prev) => {
          animate({
            ...options,
            from: 0,
            to: 1,
            onUpdate: (p) => void result(mixRect(prev, stream(), p)),
          });
          return stream();
        }, S.sample(stream));
        return result;
      }

      const Projected = ({
        rect,
        parent,
        children,
        borderRadius,
        ...other
      }) => {
        const element = S.data();
        const projection = S(() => {
          if (element()) {
            const projection = layoutNode(
              {
                onProjectionUpdate: () =>
                  updateProjectionStyle(element(), projection),
              },
              typeof parent === "function" ? parent() : undefined
            );
            projection.setLayout(element().getBoundingClientRect());
            S.cleanup(() => {
              projection.destroy();
            });
            return projection;
          }
        });
        S(() => {
          if (projection() && rect) {
            projection().setTarget(rect());
            element().style.borderRadius = correctBorderRadius(
              borderRadius,
              projection()
            );
          }
        });
        return {
          ...other,
          ref: element,
          children:
            typeof children === "function" ? children(projection) : children,
        };
      };

      S.root(() => {
        const toggle = S.data();
        const parentRect = animateRect(
          S(() =>
            toggle()
              ? { top: 0, left: 0, bottom: 300, right: 300 }
              : { top: 200, left: 200, bottom: 300, right: 300 }
          )
        );

        const childRect = animateRect(
          S(() =>
            toggle()
              ? { top: 0, left: 0, bottom: 100, right: 100 }
              : { top: 100, left: 100, bottom: 200, right: 200 }
          )
        );

        const Main = Projected({
          id: "parent",
          rect: parentRect,
          borderRadius: 16,
          onClick: () => toggle(!S.sample(toggle)),
          children: (parent) =>
            Projected({
              parent,
              borderRadius: 16,
              rect: childRect,
              id: "child",
            }),
        });

        patch(document.body, Main);
      });
    </script>
  </body>
</html>
